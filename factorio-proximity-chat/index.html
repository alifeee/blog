<!DOCTYPE html>
<html lang="en">
  <head>
    <title>alifeee - Factorio proximity chat</title>
    <!-- browser metas -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Coding Projects! #2: Making Proximity-based voice chat for Factorio"
    />

    <!-- embed metas - https://ogp.me/ -->
    <meta property="og:title" content="Making Factorio Proximity Voice Chat" />
    <meta property="og:type" content="website" />
    <meta property="og:site" content="alifeee's blog" />
    <meta
      property="og:url"
      content="https://blog.alifeee.net/factorio-proximity-chat"
    />
    <meta
      property="og:image"
      content="https://blog.alifeee.net/factorio-proximity-chat/og-image.png"
    />
    <meta
      property="og:description"
      content="Using Lua and C to enable proximity-based voice chat in Factorio"
    />
    <meta property="og:locale" content="en_GB" />

    <!-- link to mastodon -->
    <meta name="fediverse:creator" content="@alifeee@mastodon.social" />

    <!-- favicon -->
    <link rel="icon" type="image/png" href="../favicon.png" />
    <!-- stylesheets -->
    <link rel="stylesheet" href="../github-markdown.min.css" />
    <link rel="stylesheet" href="../prism.min.css" />
    <link rel="stylesheet" href="prism-atom-dark.css" />
    <link rel="stylesheet" href="../stylesheet.css" />
    <link rel="stylesheet" href="../stylesheet_md.css" />

    <!-- prismjs for code highlighting -->
    <script src="../prism.min.js"></script>
    <script src="../prism-autoloader.min.js"></script>
    <script>
      Prism.plugins.autoloader.languages_path = "/prism-components/";
    </script>

    <!-- anchorjs: https://github.com/bryanbraun/anchorjs (zero-md must be no-shadow mode)-->
    <script type="module">
      import "../anchor.min.js";
      document.addEventListener("DOMContentLoaded", function (event) {
        let tags = ["h2", "h3", "h4", "h5", "h6"];
        anchors.add("#content " + tags.join(", #content "));
      });
    </script>

    <!-- word-count component from word-count.js -->
    <script src="../word-count.js"></script>

    <style>
      /* by default, tokens (=, +, etc) have a background that...
      doesn't get set by themes */
      .language-css .token.string,
      .style .token.string,
      .token.entity,
      .token.operator,
      .token.url {
        background: none;
      }
    </style>
  </head>

  <body>
    <header>
      <a href="../">
        <h1>alifeee's blog</h1>
      </a>
      <a id="rss" href="../feed.xml">
        <img alt="_RSS_" src="../icons/rss.svg" />
      </a>
    </header>

    <main>
      <section id="content" class="markdown-body">
        <h1 id="coding-projects-2-proximity-based-voice-chat-for-factorio">
          Coding Projects! #2: Proximity-based voice chat for Factorio
        </h1>
        <p><word-count parent=".markdown-body"></word-count></p>
        <p>
          Earlier this year, I played
          <a href="https://store.steampowered.com/app/602960/Barotrauma/"
            >Barotrauma</a
          >
          weekly for 21 weeks with friends. Barotrauma is a &quot;2D co-op
          submarine simulator – in space, with survival horror and RPG
          elements&quot;, and most importantly for me: it has a proximity
          voice-chat system. This means that if you are crafting some nuclear
          fuel rods at the rear of the ship, you will not hear your crewmates
          being torn apart by eldritch beings that found their way into the
          front of the ship. You will be on your way past the medbay to fix a
          leak in the crew quarters, and hear the medical doctors through the
          door discussing which of the crewmembers to use for their next
          <em>&#39;experiment&#39;</em>. You will be picked as the next
          dead-man-walking to leave the submarine to mine precious metals, and
          will make your way across the ship to get orders in-person from the
          captain.
        </p>
        <p>
          <img
            src="images/barotrauma_mining.png"
            alt="Screenshot of Barotrauma, showing three players mining"
          />
        </p>
        <figcaption>
          <p>
            Here, three of us make small talk while we mine outside the
            submarine. What conversations were being had inside the submarine,
            we were unaware.
          </p>
        </figcaption>

        <p>
          As you can tell, I had a lot of fun playing Barotrauma; it probably
          deserves a blog post of its own. When we played, we were usually
          around 8 players, which, had we used Discord for voice chat, would
          have been chaos trying to hear what everyone was saying. Proximity
          chat added greatly to our enjoyment of the game, and planted the
          question in my mind of which other games which could be as fun. In my
          view, there are a few criteria which made Barotrauma great and that I
          would like in another game that could be as fun. They are:
        </p>
        <ul>
          <li>
            Proximity chat. Games which come to mind immediately which have this
            are Among Us and Minecraft. There are
            <a
              href="https://www.familygamingdatabase.com/en-gb/search/list/Proximity+Chat"
              >lists online</a
            >.
          </li>
          <li>
            Campaign-based. By this, I mean games where you play the same save,
            and wouldn&#39;t start fresh every week. Among Us is out.
          </li>
          <li>
            Players are... in proximity to each other. In Barotrauma, you can
            always hear mutterings and ramblings of other people as you are all
            trapped inside a submarine. In Minecraft, you may travel massive
            distances and end up spending most of your time separate from each
            other.
          </li>
        </ul>
        <p>
          The games on the
          <a
            href="https://www.familygamingdatabase.com/en-gb/search/list/Proximity+Chat"
            >above list</a
          >
          that are probably most like what I&#39;m after are Sea of Thieves and
          Ark/Rust. However, the secret fourth category is: people I know must
          own the game. So, after all that, I was suggested
          <a href="https://factorio.com/">Factorio</a>, which I thought would be
          a bunch of fun to play with a bunch of people. Factorio doesn&#39;t
          pass the third criterion of &quot;players are always vaguely close to
          each other&quot;, but it&#39;s a great game, so I&#39;m sure I can
          allow it one strike. Since I&#39;ve not played yet, it remains to be
          seen how close people remain to each other when playing: maybe people
          stick together more if they have proximity chat!
        </p>
        <p>
          There was only one problem with Factorio: it didn&#39;t have proximity
          chat. That, my dear friend, is why we&#39;re here. I wanted to play
          Factorio with proximity chat so much that I made it myself. Within
          these words lies the tales, struggle, and strife of that process.
        </p>
        <ol>
          <li>
            <a href="#research">Research</a>
            <ol>
              <li>
                <a href="#how-do-other-games-do-it"
                  >How do other games do it?</a
                >
              </li>
              <li>
                <a href="#how-can-i-do-it-for-factorio"
                  >How can I do it for Factorio?</a
                >
              </li>
              <li>
                <a href="#using-mumble">Using Mumble</a>
                <ol>
                  <li><a href="#memory-hacking">Memory hacking?</a></li>
                  <li>
                    <a href="#using-the-link-plugin">Using the Link plugin?</a>
                  </li>
                  <li>
                    <a href="#using-the-filesystem">Using the filesystem?</a>
                  </li>
                </ol>
              </li>
            </ol>
          </li>
          <li>
            <a href="#making-the-factorio-mod">Making the Factorio Mod</a>
          </li>
          <li>
            <a href="#making-the-mumble-plugin">Making the Mumble Plugin</a>
            <ol>
              <li><a href="#build-the-c-files">Build the C files</a></li>
              <li><a href="#bundle-the-plugin">Bundle the plugin</a></li>
              <li><a href="#spit-out-random-data">Spit out random data</a></li>
              <li>
                <a href="#only-run-when-factorioexe-is-running"
                  >Only run when <code>Factorio.exe</code> is running</a
                >
              </li>
              <li>
                <a href="#parse-the-factorio-log-file"
                  >Parse the Factorio log file</a
                >
              </li>
              <li>
                <a href="#check-the-log-file-exists"
                  >Check the log file exists</a
                >
              </li>
              <li>
                <a href="#check-the-log-file-is-recent"
                  >Check the log file is recent</a
                >
              </li>
              <li><a href="#build-it-on-windows">Build it on Windows</a></li>
            </ol>
          </li>
          <li><a href="#it-works-for-a-bit">It works! (for a bit)</a></li>
          <li><a href="#it-works-weirdly">It works! (weirdly)</a></li>
          <li><a href="#it-works-actually">It works! (actually)</a></li>
          <li><a href="#conclusion">Conclusion</a></li>
          <li>
            <a href="#people-who-helped">People who helped</a>
            <ol>
              <li><a href="#testing-it-works">Testing it works!</a></li>
              <li><a href="#reddit-thread-">Reddit thread ⇗</a></li>
              <li><a href="#factorio-discord-">Factorio discord ⇗</a></li>
              <li><a href="#mumble-matrix-">Mumble Matrix ⇗</a></li>
            </ol>
          </li>
          <li><a href="#links">Links</a></li>
        </ol>
        <h2 id="research">Research</h2>
        <h3 id="how-do-other-games-do-it">How do other games do it?</h3>
        <p>
          The only game I had played with user-created proximity chat before was
          <a href="https://www.innersloth.com/games/among-us/">Among Us</a>. I
          had remembered that we had all downloaded
          <a href="https://github.com/OhMyGuus/BetterCrewLink"
            >&quot;BetterCrewLink&quot;</a
          >, which was a desktop app, which connected to a voice server,
          connected to the game running on your machine, and somehow did
          proximity chat from that. Looking at the code on GitHub, the program
          read the memory addresses of things like player position, and also
          looked like it implemented its own entire
          <a href="https://en.wikipedia.org/wiki/Voice_over_IP">VoIP</a> system
          (Voice over IP).
        </p>
        <p>
          This seemed a lot of work. I didn&#39;t fancy creating (or even trying
          to clone) what is basically Discord or TeamSpeak, so I did some more
          Googling.
        </p>
        <h3 id="how-can-i-do-it-for-factorio">How can I do it for Factorio?</h3>
        <p>
          Googling around, the only mention I could find of Factorio and
          proximity voice chat was a single
          <a
            href="https://www.reddit.com/r/factorio/comments/ixtqgs/positional_voip_audio/"
            >Reddit thread</a
          >.
        </p>
        <p>
          <img src="images/reddit_thread_title.png" alt="Screenshot of Reddit
          thread. Title: "Positional VoIP audio?". Content: "Has anyone
          considered implementing positional audio for Factorio?"">
        </p>
        <p>
          Without this thread, I don&#39;t think I would have started trying to
          make a Factorio proximity chat mod. But, with the thread, I had some
          leads.
          <a href="https://www.reddit.com/user/Faxxobeat/">Faxxobeat</a> made me
          aware that <a href="https://www.mumble.info/">Mumble</a> - an open
          source voice chat client (like Discord or TeamSpeak) - had support for
          &quot;positional audio&quot; via &quot;plugins&quot;. There were
          already
          <a href="https://github.com/mumble-voip/mumble/tree/master/plugins"
            >plugins for many games</a
          >
          and lots of documentation on PA (Positional Audio). This sounded like
          an approachable plan, since this way all I had to do to implement
          proximity chat in Factorio was make a plugin for Mumble, which would
          handle the rest of the voice chat. And, reading the
          <a
            href="https://www.mumble.info/documentation/user/positional-audio/#pa-data"
            >requirements for a Mumble plugin</a
          >, I just had to write a plugin which gave Mumble the player position,
          player name and the current game server. It seemed &quot;easy
          enough&quot;.
        </p>
        <h3 id="using-mumble">Using Mumble</h3>
        <p>
          I found a <em>lot</em> of different documentation for Mumble and
          Mumble&#39;s PA. There was a
          <a href="https://wiki.mumble.info/wiki/Positional-Audio">wiki</a>, a
          <a href="https://www.mumble.info/documentation/user/positional-audio/"
            >website</a
          >, and
          <a
            href="https://github.com/mumble-voip/mumble/tree/master/docs/dev/plugins"
            >some markdown files</a
          >. These were, respectively: outdated with a banner saying as such;
          outdated with no such information; and up-to-date. Initially, I did
          not find the third guide (the up to date one), so naturally after
          seeing the wiki was outdated, I used the second, outdated (unbeknownst
          to me at the time) guide. This had several pages:
        </p>
        <ul>
          <li>
            <a
              href="https://www.mumble.info/documentation/user/positional-audio/"
              >Positional Audio (PA) explanation for users</a
            >
          </li>
          <li>
            <a
              href="https://www.mumble.info/documentation/developer/positional-audio/"
              >Positional Audio (PA) explanation for developers</a
            >
            <ul>
              <li>
                <a
                  href="https://www.mumble.info/documentation/developer/positional-audio/create-plugin/"
                  >Plugin creation explanation</a
                >
                <ul>
                  <li>
                    <a
                      href="https://www.mumble.info/documentation/developer/positional-audio/create-plugin/guide/"
                      >Plugin creation guide</a
                    >
                  </li>
                  <li>
                    <a
                      href="https://www.mumble.info/documentation/developer/positional-audio/create-plugin/memory-analysis-tools/"
                      >List of memory analysis tools</a
                    >
                  </li>
                </ul>
              </li>
              <li>
                <a
                  href="https://www.mumble.info/documentation/developer/positional-audio/link-plugin/"
                  >Link plugin explanation</a
                >
              </li>
            </ul>
          </li>
        </ul>
        <p>
          That&#39;s a lot of docs. The guide above is
          <em>very</em> comprehensive, so I tried to follow it. However, as I
          said, it was outdated. Having followed links from the wiki which said
          &quot;the wiki is outdated, please use the website&quot;, the
          potential that the website was outdated was not on my radar, so I
          ploughed on.
        </p>
        <h4 id="memory-hacking">Memory hacking?</h4>
        <p>
          The plugin guide leads you through creating a plugin which searches a
          game&#39;s memory for memory addresses of the player position and
          other variables. I attempted this a little with Cheat Engine, but it
          led nowhere for Factorio. As I could&#39;ve learnt by reading the
          <a
            href="https://www.reddit.com/r/factorio/comments/ixtqgs/positional_voip_audio/"
            >Reddit thread</a
          >
          I already found: Factorio does not use static memory addresses for
          player data. Thus, I could not use memory hacking to make a plugin.
        </p>
        <h4 id="using-the-link-plugin">Using the Link plugin?</h4>
        <p>
          The next option was the
          <a
            href="https://www.mumble.info/documentation/developer/positional-audio/link-plugin/"
            >link plugin</a
          >, which works generically for any game. This is meant to be for the
          developers of the game to implement themselves (by providing some
          known-location memory addresses which are updated with player position
          data, which Mumble can then find), but I also thought that it could be
          possible to make a mod which does similar (at game startup: write
          position data to memory and keep it updated when playing).
        </p>
        <p>
          Factorio provides a modding API, using Lua, making everyone&#39;s
          lives easier when it comes to modding, as you can just write a mod in
          Lua, and it should stay compatible with small game updates. This seems
          much more fun than other ecosystems like Minecraft where
          <a href="https://ftb.fandom.com/wiki/Thaumcraft_1">mods</a> become
          <a href="https://ftb.fandom.com/wiki/Thaumcraft_2">unplayable</a>
          because they have to be
          <a href="https://ftb.fandom.com/wiki/Thaumcraft_3">updated</a> for
          <a href="https://ftb.fandom.com/wiki/Thaumcraft_4">each version</a> of
          <a href="https://ftb.fandom.com/wiki/Thaumcraft_5">the game</a> that
          <a href="https://ftb.fandom.com/wiki/Thaumcraft_6">releases</a>. Since
          I wanted whatever I made to be long-lasting, I wanted to use the
          official modding API. This meant using Lua. Everything that I could do
          with code was now described by the
          <a href="https://lua-api.factorio.com/latest/">Factorio API Docs</a>.
          Unfortunately, playing with memory was not on this list, so using the
          Link plugin was also not possible.
        </p>
        <h4 id="using-the-filesystem">Using the filesystem?</h4>
        <p>
          My final idea was that I could make a simple Factorio mod in Lua which
          writes the position of the player to a file, and then I could write a
          Mumble plugin in C which looks for and reads this file, exposing the
          data to Mumble&#39;s Positional Audio system. This would mean that to
          use the plugin, you need to install two things: the Factorio mod; and
          the Mumble plugin, but it also made the connection between Mumble and
          Factorio minimal, as either the mod or plugin could be easily changed
          without needing to change the other, since they were only interacting
          via file write or file read.
        </p>
        <p>
          At this point, I had popped my head into the Mumble Matrix chat via a
          <a href="https://www.mumble.info/contact/"
            >link I found on the website</a
          >
          and chatted with some developers about making the plugin. Thankfully,
          this is when I found out that I&#39;d been following an outdated
          guide, and was pointed to the most recent, updated, and clear
          <a
            href="https://github.com/mumble-voip/mumble/tree/master/docs/dev/plugins"
            >markdown documentation</a
          >.
        </p>
        <h2 id="making-the-factorio-mod">Making the Factorio Mod</h2>
        <p>
          The brief was clear: make a mod which took the player position, and
          write it to a file.
        </p>
        <p>
          I had never modded Factorio or used Lua before, so I read some
          <a href="https://wiki.factorio.com/Tutorial:Modding_tutorial"
            >Factorio modding tutorial</a
          >
          and <a href="https://www.lua.org/">read about Lua</a> too.
        </p>
        <p>
          Then, I joined the
          <a href="https://discord.com/invite/factorio">Factorio discord</a> to
          ask how I could go about doing what I wanted. Less than 30 minutes<a
            href="https://discord.com/channels/139677590393716737/306402592265732098/1153658704835657729"
            >¹</a
          >
          after my initial message, a user,
          <a href="https://mods.factorio.com/user/Xorimuth">Xorimuth</a>, told
          me that you could write files with Factorio&#39;s
          <a
            href="https://lua-api.factorio.com/latest/classes/LuaGameScript.html#write_file"
            >write_file</a
          >
          function, and provided a code snippet to do what I wanted:
        </p>
        <pre><code class="language-lua">script.on_nth_tick(30, function()
  for _, player in pairs(game.connected_players) do
    game.write_file(&quot;player_position.txt&quot;, serpent.dump(player.position), false, player.index)
  end
end)
</code></pre>
        <p>
          This, basically, was the finished Factorio mod. I made some small
          changes and re-formatted it and the whole Factorio mod is one script
          and 12 lines:
        </p>
        <pre><code class="language-lua">script.on_nth_tick(5, function()
    for index, player in pairs(game.connected_players) do
        local info = &quot;XYZ, Player, sUrface, Server\n&quot; .. 
               &quot;x: &quot; .. player.position.x .. &quot;\n&quot; .. 
               &quot;y: &quot; .. player.position.y .. &quot;\n&quot; .. 
               &quot;z: &quot; .. 0 .. &quot;\n&quot; .. 
               &quot;p: &quot; .. index .. &quot;\n&quot; .. 
               &quot;u: &quot; .. player.surface.index .. &quot;\n&quot; .. 
               &quot;s: &quot; .. game.get_player(1).name .. &quot;\n&quot;
        game.write_file(&quot;mumble_positional-audio_information.txt&quot;, info, false, player.index)
    end
end)
</code></pre>
        <figcaption>
          <p>
            In Lua, <code>..</code> concatenates strings and whitespace is
            ignored. Fun :).
          </p>
        </figcaption>

        <p>
          Every 1/12 of a second (5 ticks), this outputs something a text file
          into
          <a href="https://wiki.factorio.com/Application_directory"
            >Factorio&#39;s <code>script-output</code> folder</a
          >
          that looks like:
        </p>
        <pre><code class="language-text">XYZ, Player, sUrface, Server
x: -54.8046875
y: 71.08203125
z: 0
p: 1
u: 1
s: alifeee
</code></pre>
        <figcaption>
          <p>
            You may complain at me for <code>sUrface</code>, but
            <a href="https://youtu.be/DrQqajtiRt4">I think it&#39;s neat</a>.
          </p>
        </figcaption>

        <p>
          That&#39;s it! Now for the Mumble plugin. I&#39;m sure it will
          definitely be as easy and not take much, <em>much</em> longer.
        </p>
        <h2 id="making-the-mumble-plugin">Making the Mumble Plugin</h2>
        <p>
          After finding the up-to-date documentation for-real-this-time, I also
          found the
          <a href="https://github.com/mumble-voip/mumble-plugin-template"
            >Mumble plugin template</a
          >. This was a simple implementation of a Mumble plugin, with the
          latest API, written in C. In theory, it was
          <a
            href="https://github.com/mumble-voip/mumble/blob/master/docs/dev/plugins/LanguageBindings.md"
            >possible to use C++ or Rust</a
          >
          to write the plugin, but to keep it simple, I decided to keep to C. I
          had also found that there was a
          <a href="https://github.com/mumble-voip/mumble-pahelper"
            >Positional Audio Helper</a
          >, which was only available in the pre-release of Mumble,
          <a href="https://www.mumble.info/blog/mumble-1.5.517-rc/"
            >version 1.5</a
          >, so I installed that (which will come back to bite me, as you will
          see...). The helper showed all the data involved with positional
          audio:
        </p>
        <p>
          <img
            src="images/mumble_pa-helper.png"
            alt="Screenshot of Mumble PA helper, showing lots of debug information including player and camera positions."
          />
        </p>
        <figcaption>
          <p>
            PA uses: <code>position</code> (where you are),
            <code>direction</code> (which way you&#39;re facing) and
            <code>axis</code> (which way you&#39;re leaning, for games with
            leaning) for the player and the camera;
            <code>Context</code> (usually a server ID) to determine if the
            players are in the same game-server; and
            <code>Identity</code> (usually player ID) to tell players apart. If
            your context is the same as another person&#39;s, you will hear them
            based on where they are in the game. Positional audio!
          </p>
        </figcaption>

        <p>
          Now, I had a debug window showing lots of 0s that I needed to put
          values in, and a well-described plugin API, so I forked the
          <a href="https://github.com/mumble-voip/mumble-plugin-template"
            >Mumble plugin template</a
          >
          and started developing.
        </p>
        <h3 id="build-the-c-files">Build the C files</h3>
        <p>
          First, I had to be able to build the plugin. After screwing around for
          too long installing <a href="https://gcc.gnu.org/">GCC</a> I decided
          to just use GitHub Actions to build the C file, as I found an
          <a
            href="https://github.com/alifeee/Factorio-Proximity-Voice-Chat/new/master?filename=.github%2Fworkflows%2Fcmake-multi-platform.yml&workflow_template=ci%2Fcmake-multi-platform"
            >official template for building multi-platform C and C++ projects</a
          >. This built the plugin for Linux and Windows whenever I pushed to
          the repository. I also was able to build the plugin with GCC, for
          Linux, on WSL, but I hadn&#39;t managed to install it for Windows yet,
          and had to wait several minutes for the action to complete if I wanted
          a Windows version. This worked fine initially, as I mostly was writing
          and testing C code on Linux, then I would copy it into the main plugin
          file if I wanted to try it on Windows. Because I was just reading and
          writing a file initially, it didn&#39;t matter whether I was writing
          on Windows or Linux. At least, not until I wanted to test it at the
          same time as playing Factorio.
        </p>
        <h3 id="bundle-the-plugin">Bundle the plugin</h3>
        <p>
          Next, I wanted to make the plugin installable using the Mumble UI.
          Following
          <a
            href="https://github.com/mumble-voip/mumble/blob/master/docs/dev/plugins/Bundling.md"
            >the bundling guide</a
          >, this involved writing a <code>manifest.xml</code> file
        </p>
        <pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;bundle version=&quot;1.0.0&quot;&gt;
  &lt;assets&gt;
    &lt;plugin os=&quot;windows&quot; arch=&quot;x64&quot;&gt;plugin.dll&lt;/plugin&gt;
    &lt;plugin os=&quot;linux&quot; arch=&quot;x64&quot;&gt;libplugin.so&lt;/plugin&gt;
  &lt;/assets&gt;
  &lt;name&gt;Factorio Positional Audio&lt;/name&gt;
  &lt;version&gt;1.0.0&lt;/version&gt;
&lt;/bundle&gt;
</code></pre>
        <p>
          ...and then zipping the built C files and
          <code>manifest.xml</code> file, and renaming the file to end in
          <code>.mumble_plugin</code>. This is well summarised by the
          <a
            href="https://github.com/alifeee/Factorio-Proximity-Voice-Chat/blob/1b9642729f122463b356c865a170594d3e0b8dfc/.github/workflows/release.yml#L83-L88"
            >GitHub workflow that does exactly that</a
          >:
        </p>
        <pre><code class="language-yaml">- name: Bundle
  run: |
    mv build/libfactorio_linux_x86_64.so libplugin.so
    mv build/Release/plugin.dll plugin.dll
    mv mumble/manifest.xml manifest.xml
    zip -MM factorio.mumble_plugin manifest.xml libplugin.so plugin.dll
</code></pre>
        <figcaption>
          <p>
            Every character has a story. Here, the story is that little
            <code>-MM</code>. Without it, <code>zip</code> ignored any missing
            files. I spent a while wondering why my plugin didn&#39;t work
            before realising that <code>manifest.xml</code> didn&#39;t exist,
            and <code>zip</code> was just happily ignoring that fact.
          </p>
        </figcaption>

        <h3 id="spit-out-random-data">Spit out random data</h3>
        <p>
          The function that Mumble calls to get positional data is
          <code>mumble_fetchPositionalData</code>. To check it worked before I
          carried on, I first output random data to see it in the helper.
        </p>
        <pre><code class="language-c">bool mumble_fetchPositionalData(float *avatarPos, float *avatarDir, float *avatarAxis, float *cameraPos, float *cameraDir, float *cameraAxis, const char **context, const char **identity)
{
  avatarPos[0] = 0.01f + ((float)rand() / (float)RAND_MAX) * 0.01f;
  avatarPos[1] = 0.01f + ((float)rand() / (float)RAND_MAX) * 0.01f;
  avatarPos[2] = 0.01f + ((float)rand() / (float)RAND_MAX) * 0.01f;

  ...

  return true;
}
</code></pre>
        <p>This worked great!</p>
        <p>
          <img
            src="images/mumble_pa-viewer_random-data.png"
            alt="Screenshot of x, y, z coordinates in the PA Viewer, showing random data"
          />
        </p>
        <p>
          Now I had remembered how C works, and had a better grasp of the Mumble
          API, I could start attaching the plugin to Factorio.
        </p>
        <h3 id="only-run-when-factorioexe-is-running">
          Only run when <code>Factorio.exe</code> is running
        </h3>
        <p>
          At this stage, the plugin was always active. The first integration
          step was to get it to only activate if <code>Factorio.exe</code> was
          running. Mumble occasionally calls
          <code>mumble_initPositionalData</code> for each installed plugin to
          see if they should begin. In this case, we should begin (return OK) if
          the game is open.
        </p>
        <pre><code class="language-c">uint8_t mumble_initPositionalData(const char *const *programNames, const uint64_t *programPIDs, size_t programCount)
{
  // programNames is a list of, e.g., [&quot;Notion.exe&quot;, &quot;System&quot;, &quot;firefox.exe&quot;, &quot;factorio.exe&quot;]
  // loop through programs, if FACTORIO_EXE is found, return MUMBLE_PDEC_OK
  bool found = false;
  for (size_t i = 0; i &lt; programCount; i++)
  {
    if (strcmp(programNames[i], FACTORIO_EXE) == 0)
    {
      found = true;
      break;
    }
  }

  if (!found)
  {
  // If the game is not running, return MUMBLE_PDEC_ERROR_TEMP
  return MUMBLE_PDEC_ERROR_TEMP;
  }

  return MUMBLE_PDEC_OK;
}
</code></pre>
        <h3 id="parse-the-factorio-log-file">Parse the Factorio log file</h3>
        <p>
          To get the data from the text file, it has to be parsed. This is done
          with this code
        </p>
        <pre><code class="language-c">int parse_factorio_logfile(float *x, float *y, float *z, int *player, int *surface, char **server, size_t *server_len, int *error)
{
  f_data = c_read_file(factorioLogfile, &amp;err, &amp;f_size);

  // split by newline
  line = strtok_r(f_data, &quot;\n&quot;, &amp;saveptr);
  while (line != NULL)
  {
    // skip first line
    if (strstr(line, &quot;XYZ&quot;) != NULL)
    {
      line = strtok_r(NULL, &quot;\n&quot;, &amp;saveptr);
      continue;
    }
    // split by colon
    token2 = strtok_r(line, &quot;:&quot;, &amp;saveptr2);
    value2 = strtok_r(NULL, &quot;:&quot;, &amp;saveptr2);

    if (strcmp(token2, &quot;x&quot;) == 0)
    {
      *x = atof(value2);
    }
    else if (strcmp(token2, &quot;y&quot;) == 0)
    {
      *y = atof(value2);
    }
    else if (strcmp(token2, &quot;z&quot;) == 0)
    {
      *z = atof(value2);
    }

    ...

    line = strtok_r(NULL, &quot;\n&quot;, &amp;saveptr);
  }
}
</code></pre>
        <figcaption>
          <p>
            There&#39;s some funky C stuff going on here. Functions can&#39;t
            return multiple values, so the function arguments are pointers which
            are edited (a way of getting data from a function).
            <code>strtok</code> is another weird one, which splits strings on a
            value, requiring you to sometimes give the first argument
            <code>NULL</code> for it to return the <em>second</em> or
            <em>third</em> split.
          </p>
        </figcaption>

        <h3 id="check-the-log-file-exists">Check the log file exists</h3>
        <p>
          At this point, the plugin would now see <code>Factorio.exe</code> and
          immediately try to open the log file. Problem is: it might not be
          there; if the user hasn&#39;t installed the Factorio mod yet, or not
          loaded a save. To protect against this, I wrote some C to check if the
          file exists before opening it
        </p>
        <pre><code class="language-c">int file_exists(const char *fname)
{
  FILE *file;
  if ((file = fopen(fname, &quot;r&quot;)))
  {
    fclose(file);
    return 1;
  }
  return 0;
}
</code></pre>
        <h3 id="check-the-log-file-is-recent">Check the log file is recent</h3>
        <p>
          The final issue I considered was that the plugin would still see the
          log file if you quit a game to the main menu. This would mean that you
          would still hear people from the most recent server you were connected
          to. To solve this, I wanted to either blank the log file, or write
          different data to it when you quit a server. However, Factorio
          <a
            href="https://discord.com/channels/139677590393716737/306402592265732098/1154080788921466970"
            >doesn&#39;t allow</a
          >
          executing code on exiting a save. So, my rudimentary solution was to
          just only enable the plugin if the log file was written recently. This
          way, when you quit, the file grows stale so is no longer used. I did
          this with a fairly simple C function (here, simple stands for
          &quot;short&quot; and <em>not</em> &quot;the code is
          understandable&quot;)
        </p>
        <pre><code class="language-c">time_t get_file_modified_time(char *path)
{
  struct stat attr;
  stat(path, &amp;attr);
  return attr.st_mtime;
}
</code></pre>
        <h3 id="build-it-on-windows">Build it on Windows</h3>
        <p>
          At this point, I’d only been able to compile the code locally on Linux
          (via WSL). For Windows, I used GitHub actions. This was possible as I
          didn’t yet need to test it with Mumble, as it was mainly just opening
          and parsing a file, which could be done on Linux. However, I use
          Windows for both Factorio and Mumble. Building via Actions took around
          5 minutes; I wanted to be able to compile locally for a quicker
          development cycle. This was ultimately a pain as I didn’t want to
          install Visual Studio on my (not-a-lot-of-space) laptop, so I tried to
          install GCC for windows, which had many issues. I ended up finding
          that you could install Visual Studio build tools and use it from the
          CLI.
        </p>
        <p>
          <img
            src="./images/visual-studio-build-tools.png"
            alt="Screenshot of Visual Studio Build Tools installer"
          />
        </p>
        <figcaption>
          <p>
            Installing Visual Studio Build Tools. I&#39;ve never seen so many
            installation options or checkboxes than in the Visual Studio
            installer (which is an entire program in itself).
          </p>
        </figcaption>

        <p>
          After adding a bunch of functions which were available on Linux but
          missing on Windows, I could now build the mumble plugin locally on
          Windows. With
          <a
            href="https://github.com/alifeee/Factorio-Proximity-Voice-Chat/#windows"
            >one command</a
          >
          I could build, and package the code into
          <code>factorio.mumble_plugin</code>, so I could quickly change the
          code and reinstall it.
        </p>
        <pre><code class="language-bash">cmake -S .\mumble\ -B .\build\ -DCMAKE_C_COMPILER=cl; cmake --build .\build\ --config Release; bash package_windows.sh
</code></pre>
        <figcaption>
          The build and package command for Windows Powershell
        </figcaption>

        <h2 id="it-works-for-a-bit">It works! (for a bit)</h2>
        <p>
          Now, I had followed the steps that I dreamt up and had a Factorio mod
          which wrote the player position to a file, and a Mumble plugin which
          read from that file, parsed the position, and gave it to Mumble.
          Opening Factorio and Mumble at the same time, it worked!
        </p>
        <p>
          <img
            src="./images/factorio_with_PAHelper.png"
            alt="Left: Factorio. Right: Mumble PA helper displaying positional information"
          />
        </p>
        <figcaption>
          <p>
            The PA helper shows me as in-game, and correctly displays my
            position!
          </p>
        </figcaption>

        <p>There was only one small, tiny, nagging issue.</p>
        <p>Every time I started it, Mumble crashed after 10 or so seconds.</p>
        <p>
          <img
            src="images/mumble_crash.png"
            alt="Screenshot of Mumble crash report"
          />
        </p>
        <figcaption>
          <p>:(</p>
        </figcaption>

        <p>
          This was the first point at which I didn&#39;t know what was going on.
          Initially, I thought there may be problems with file reading/writing
          at the same time. That is, that Factorio would write a file in the
          middle of Mumble trying to read it. So, I
          <a
            href="https://github.com/alifeee/Factorio-Proximity-Voice-Chat/commit/c6a87c8ec8b9899ad6bbd0a6d8906053c0d78cf8"
            >tried to fix it</a
          >
          by reducing the read-time of the file, and by returning an error if
          the file was changed midway through reading it. This didn&#39;t fix
          it: it was still crashing. I had now run out of guesses for why.
        </p>
        <p>
          In its current implementation, the code tried to read the file, and if
          it failed to read it, did nothing. If the file was there and was
          opened with no issue, then it continued as normal. So what caused the
          crash?
        </p>
        <p>
          After many days of thinking and a few hours of debugging, most of
          which I&#39;ve forgotten what I tried, I eventually just started
          printing out the log file and watching it with my eyes. It looked
          normal, apart from it was supposed to print every 12th of a second,
          and the rhythm was slightly off (you can tell how long I sat watching
          scrolling text). This was when I realised I probably should have been
          printing a header, or something in-between prints, because what was
          happening was that sometimes the <em>file was empty</em>. I am still
          not sure why this is the case, but I assume it is something to do with
          Factorio falling behind on code execution, so rather than waiting, it
          just writes an empty file and moves on to the next task.
        </p>
        <p>
          This, naturally, meant that the C code tried to find the
          <code>&quot;x: &quot;</code> row, failed, and crashed (perhaps
          there&#39;s also something to say here about my error handling while
          parsing the file...). I
          <a
            href="https://github.com/alifeee/Factorio-Proximity-Voice-Chat/commit/a858d5033669c8ad5722aadd199d52e948ca02b1"
            >added a catch</a
          >
          for if the file was empty and rebuilt the plugin.
        </p>
        <h2 id="it-works-weirdly">It works! (weirdly)</h2>
        <p>
          Now it wasn&#39;t crashing, I could test the whole reason for making
          this: the voice chat! I found a friend, called &quot;a game dev who
          hates their corporate job&quot; [sic], and we hopped in a game
          together, installed the mod and plugin, and started monologuing (the
          sound-test type, not the vanity type).
        </p>
        <p>
          After a lot of running around and a lot of mental gymnastics, we
          figured out that it &#39;sort of&#39; worked. This is a synonym for
          &#39;didn&#39;t work but spicily&#39;. We found that our
          &#39;ears&#39; were stuck at the map origin, <code>(0, 0)</code>, and
          our &#39;mouths&#39; were attached to our players. This meant that if
          one of us stood in the centre of the map, and the other walked around,
          proximity chat worked as expected (their volume decreased, and they
          came out of the left/right headphones), but if we both walked around,
          we could still hear each other as if we were stood still at
          <code>(0, 0)</code>.
        </p>
        <p>
          To be honest, I still can&#39;t explain how this happens, but I
          already had a suspicion why: because I hadn&#39;t actually thought
          about Mumble&#39;s coordinate system. I just plugged Factorio&#39;s
          <code>x</code> and <code>y</code> coordinates into Mumble&#39;s. After
          reading
          <a
            href="https://www.mumble.info/documentation/developer/positional-audio/create-plugin/guide/#explanation-of-sound-and-coordinate-systems"
            >Mumble&#39;s documentation</a
          >, I came up with a transform from Factorio to Mumble coordinates and
          <a
            href="https://github.com/alifeee/Factorio-Proximity-Voice-Chat/commit/0443f05342025088c6866317b79d3bf8e4619c91"
            >rewrote the code</a
          >.
        </p>
        <pre><code class="language-c">// Factorio coordinates are:
// x: east- west+
// y: north- south+

// Mumble coordinates are:
// x: east- west+
// y: up+ down-
// z: north+ south-

// thus, Mumble coordinates are:
// x: Factorio x
// y: Factorio z
// z: Factorio -y
</code></pre>
        <p>
          The final issue I had was that on Mumble 1.5 (experimental release),
          the voice chat volume never went silent, no matter how far away
          someone was. However, this was an issue with Mumble, and
          <a href="https://github.com/mumble-voip/mumble/issues/6149"
            >already known about</a
          >. This meant that we had to use Mumble 1.4. The negative with that
          was that there was no PA Viewer, but since the plugin was already
          made, that was fine enough. It would just require reinstalling Mumble
          1.5 to debug it again.
        </p>
        <h2 id="it-works-actually">It works! (actually)</h2>
        <p>After all that, it worked!</p>
        <p>
          <img
            src="images/factorio_working.png"
            alt="Screenshot. Left: Factorio. Right: Mumble with PA helper, displaying correct coordinates"
          />
        </p>
        <figcaption>
          <p>This time the coordinates are correct!</p>
        </figcaption>

        <p>
          The only further thing I did was grab
          <a href="#testing-it-works">two more friends</a> to play a four-player
          game of Factorio for 20 minutes to test the entire process in-situ.
          This worked great! We could hear each other when close, and could do
          our own things in pairs!
        </p>
        <p>
          I cleaned up the presentation of the project, made a
          <a
            href="https://github.com/alifeee/Factorio-Proximity-Voice-Chat/blob/master/factorio/thumbnail.png"
            >logo</a
          >, and made the
          <a
            href="https://github.com/alifeee/Factorio-Proximity-Voice-Chat/releases/tag/v1.0.0"
            >1.0.0 release</a
          >. The mod is available on the
          <a href="https://mods.factorio.com/mod/proximity-voice-chat"
            >Factorio mods website</a
          >
          and the source code on
          <a href="https://github.com/alifeee/Factorio-Proximity-Voice-Chat/"
            >the GitHub</a
          >
          :)
        </p>
        <p>
          <img
            src="images/factorio-mod-portal.png"
            alt="Screenshot of mod from Factorio mod portal"
          />
        </p>
        <h2 id="conclusion">Conclusion</h2>
        <p>
          To wrap things up, I also
          <a
            href="https://www.reddit.com/r/factorio/comments/ixtqgs/positional_voip_audio/k3nm9mq/"
            >commented on the original Reddit thread</a
          >
          telling the author I&#39;d made the mod.
        </p>
        <p>
          The only thing left to do now is... play the game! As mentioned in the
          introduction, I hope to play a &#39;big game&#39; of Factorio, which
          should be helped greatly by the option of proximity-based voice chat.
        </p>
        <p>
          As of writing, there are six
          <a
            href="https://github.com/alifeee/Factorio-Proximity-Voice-Chat/issues"
            >open issues</a
          >
          on the GitHub, so... still lots to do! This was a fun project to
          create, and I&#39;ve definitely learnt a lot. [Other conclusionary
          remarks redacted]
        </p>
        <p>Go forth and chat!</p>
        <h2 id="people-who-helped">People who helped</h2>
        <p>
          Lots of people helped me make this! As well as the standard anonymous
          forum people who provided C functions, help, and debugging ideas, I
          had a lot of help from others. Here are some!
        </p>
        <p>
          Everyone&#39;s help was invaluable, and I wouldn&#39;t have been
          developing this if not for it :)
        </p>
        <h3 id="testing-it-works">Testing it works!</h3>
        <ul>
          <li>A game dev who hates their corporate job [sic]</li>
          <li><a href="https://github.com/roberto-holmes">Roberto</a></li>
          <li>Branton</li>
        </ul>
        <h3 id="reddit-thread-">
          Reddit thread
          <a
            href="https://www.reddit.com/r/factorio/comments/ixtqgs/positional_voip_audio/"
            >⇗</a
          >
        </h3>
        <ul>
          <li>
            <a href="https://www.reddit.com/user/Faxxobeat/">u/Faxxobeat</a>
          </li>
          <li>
            <a href="https://www.reddit.com/user/Yoyobuae/">u/Yoyobuae</a>
          </li>
        </ul>
        <h3 id="factorio-discord-">
          Factorio discord <a href="https://discord.com/invite/factorio">⇗</a>
        </h3>
        <ul>
          <li>Xorimuth</li>
          <li>justarandomgeek</li>
          <li>Solonarv, Mernom, Danielv123</li>
        </ul>
        <h3 id="mumble-matrix-">
          Mumble Matrix
          <a href="https://matrix.to/#/#mumble-dev:matrix.org">⇗</a>
        </h3>
        <ul>
          <li>@davidebeatrici</li>
          <li>@hartmnt</li>
          <li>@krzmbrzl_raven</li>
        </ul>
        <h2 id="links">Links</h2>
        <ul>
          <li>
            <p>Factorio mod page</p>
            <p>
              <a href="https://mods.factorio.com/mod/proximity-voice-chat"
                >https://mods.factorio.com/mod/proximity-voice-chat</a
              >
            </p>
          </li>
          <li>
            <p>GitHub repository</p>
            <p>
              <a
                href="https://github.com/alifeee/Factorio-Proximity-Voice-Chat/"
                >https://github.com/alifeee/Factorio-Proximity-Voice-Chat/</a
              >
            </p>
          </li>
        </ul>
      </section>
      <hr />

      <section id="comments">
        <h2>Comments</h2>
        <p>
          Email me →
          <a href="mailto:alifeee@alifeee.net">alifeee@alifeee.net</a>
          :)
        </p>
        <p>
          Message me on any social media →
          <a href="https://linktr.ee/alifeee">https://linktr.ee/alifeee</a> :)
        </p>
      </section>
    </main>

    <footer>
      <div class="links">
        <a href="https://github.com/alifeee/blog">
          <img alt="_GitHub_" src="../icons/github.svg" />
          <span class="text">GitHub</span>
        </a>
        <a href="https://linktr.ee/alifeee">
          <img alt="_Linktree_" src="../icons/linktree-logo-icon.svg" />
          <span class="text">Linktree</span>
        </a>
        <a href="mailto:alifeee@alifeee.net">
          <img alt="_Email_" src="../icons/envelope-solid.svg" />
          <span class="text">Email</span>
        </a>
      </div>
      <a class="backlink" href="../">Back to main page</a>
    </footer>
  </body>
  <style>
    :root {
      --text-colour: #fff;
      --link-colour: #e39827;
      --unimportanttext-colour: #ccc;
      --border-colour: #e39827;
      --background-colour: #002b02;
    }
    body {
      background-image: url("./images/grass-tiled.jpg");
    }
  </style>
</html>
